// Package builder demonstrates a functional builder pattern using fp-go.
// It shows how to construct and validate Person objects using lenses, prisms,
// and functional composition, separating the building phase (PartialPerson)
// from the validated result (Person).
package builder

import (
	"github.com/IBM/fp-go/v2/array"
	A "github.com/IBM/fp-go/v2/array"
	"github.com/IBM/fp-go/v2/endomorphism"
	F "github.com/IBM/fp-go/v2/function"
	"github.com/IBM/fp-go/v2/identity"
	"github.com/IBM/fp-go/v2/optics/prism"
	"github.com/IBM/fp-go/v2/option"
	"github.com/IBM/fp-go/v2/reader"
	"github.com/IBM/fp-go/v2/readeroption"
	S "github.com/IBM/fp-go/v2/string"
)

var (
	// partialPersonLenses provides lens accessors for PartialPerson fields.
	// Generated by the fp-go:Lens directive in types.go.
	partialPersonLenses = MakePartialPersonRefLenses()

	// personLenses provides lens accessors for Person fields.
	// Generated by the fp-go:Lens directive in types.go.
	personLenses = MakePersonRefLenses()

	// emptyPartialPerson is a zero-value PartialPerson used as a starting point for building.
	emptyPartialPerson = F.Zero[*PartialPerson]()

	// emptyPerson is a zero-value Person used as a starting point for validation.
	emptyPerson = F.Zero[*Person]()

	// monoidPartialPerson is a monoid for composing endomorphisms on PartialPerson.
	// Allows combining multiple builder operations.
	monoidPartialPerson = endomorphism.Monoid[*PartialPerson]()

	// foldPersons folds an array of Person operations into a single Reader.
	foldPersons = array.Fold(reader.ApplicativeMonoid[*Person](monoidPartialPerson))

	// namePrism is a prism that validates and converts between string and NonEmptyString.
	// It ensures the name is not empty, returning None if validation fails.
	//
	// Forward direction: string -> Option[NonEmptyString] (validates non-empty)
	// Reverse direction: NonEmptyString -> string (always succeeds)
	namePrism = prism.MakePrismWithName(
		func(s string) Option[NonEmptyString] {
			if S.IsEmpty(s) {
				return option.None[NonEmptyString]()
			}
			return option.Of(NonEmptyString(s))
		},
		func(ns NonEmptyString) string {
			return string(ns)
		},
		"NonEmptyString",
	)

	// agePrism is a prism that validates and converts between int and AdultAge.
	// It ensures the age is at least 18, returning None if validation fails.
	//
	// Forward direction: int -> Option[AdultAge] (validates >= 18)
	// Reverse direction: AdultAge -> int (always succeeds)
	agePrism = prism.MakePrismWithName(
		func(a int) Option[AdultAge] {
			if a < 18 {
				return option.None[AdultAge]()
			}
			return option.Of(AdultAge(a))
		},
		func(aa AdultAge) int {
			return int(aa)
		},
		"AdultAge",
	)

	// WithName is a builder function that sets the Name field of a PartialPerson.
	// It returns an endomorphism that can be composed with other builder operations.
	//
	// Example:
	//   builder := WithName("Alice")
	//   person := builder(&PartialPerson{})
	WithName = partialPersonLenses.name.Set

	// WithAge is a builder function that sets the Age field of a PartialPerson.
	// It returns an endomorphism that can be composed with other builder operations.
	//
	// Example:
	//   builder := WithAge(25)
	//   person := builder(&PartialPerson{})
	WithAge = partialPersonLenses.age.Set

	// PersonPrism is a prism that converts between a builder pattern (Endomorphism[*PartialPerson])
	// and a validated Person in both directions.
	//
	// Forward direction (buildPerson): Endomorphism[*PartialPerson] -> Option[*Person]
	//   - Applies the builder to an empty PartialPerson
	//   - Validates all fields using namePrism and agePrism
	//   - Returns Some(*Person) if all validations pass, None otherwise
	//
	// Reverse direction (buildEndomorphism): *Person -> Endomorphism[*PartialPerson]
	//   - Extracts validated fields from Person
	//   - Converts them back to raw types
	//   - Returns a builder that reconstructs the PartialPerson
	//
	// This enables bidirectional conversion with validation in the forward direction.
	PersonPrism = prism.MakePrismWithName(buildPerson(), buildEndomorphism(), "Person")
)

// MakePerson creates a builder (endomorphism) that sets both name and age fields
// on a PartialPerson. This is a convenience function that combines WithName and
// WithAge into a single builder operation.
//
// Parameters:
//   - name: The name to set (will be validated later when converting to Person)
//   - age: The age to set (will be validated later when converting to Person)
//
// Returns:
//
//	An endomorphism that applies both field setters to a PartialPerson
//
// Example:
//
//	builder := MakePerson("Alice", 25)
//	partial := builder(&PartialPerson{})
//	// partial now has Name="Alice" and Age=25
func MakePerson(name string, age int) Endomorphism[*PartialPerson] {
	return F.Flow2(
		identity.ApS(WithName, name),
		identity.ApS(WithAge, age),
	)
}

// buildPerson constructs the forward direction of PersonPrism.
// It takes a builder (Endomorphism[*PartialPerson]) and attempts to create
// a validated Person by:
//  1. Applying the builder to an empty PartialPerson
//  2. Extracting and validating the Name field using namePrism
//  3. Extracting and validating the Age field using agePrism
//  4. Combining the validated fields into a Person
//
// Returns:
//
//	A ReaderOption that produces Some(*Person) if all validations pass,
//	or None if any validation fails.
func buildPerson() ReaderOption[Endomorphism[*PartialPerson], *Person] {

	maybeName := F.Flow2(
		partialPersonLenses.name.Get,
		namePrism.GetOption,
	)

	maybeAge := F.Flow2(
		partialPersonLenses.age.Get,
		agePrism.GetOption,
	)

	makePerson := F.Pipe2(
		readeroption.Do[*PartialPerson](emptyPerson),
		readeroption.ApSL(personLenses.Name, maybeName),
		readeroption.ApSL(personLenses.Age, maybeAge),
	)

	return F.Flow2(
		reader.Read[*PartialPerson](emptyPartialPerson),
		makePerson,
	)
}

// buildEndomorphism constructs the reverse direction of PersonPrism.
// It takes a validated Person and creates a builder (Endomorphism[*PartialPerson])
// that can reconstruct the equivalent PartialPerson by:
//  1. Extracting the validated Name field and converting it back to string
//  2. Extracting the validated Age field and converting it back to int
//  3. Creating setters for the PartialPerson fields
//
// This reverse direction always succeeds because Person contains only valid data.
//
// Returns:
//
//	A Reader that produces an endomorphism for reconstructing a PartialPerson
func buildEndomorphism() Reader[*Person, Endomorphism[*PartialPerson]] {

	// name extracts the validated name, converts it to string,
	// and creates a setter for PartialPerson's Name field
	name := F.Flow3(
		personLenses.Name.Get,
		namePrism.ReverseGet,
		WithName,
	)

	// age extracts the validated age, converts it to int,
	// and creates a setter for PartialPerson's Age field
	age := F.Flow3(
		personLenses.Age.Get,
		agePrism.ReverseGet,
		WithAge,
	)

	// Combine the field extractors into a single builder
	return F.Pipe1(
		A.From(name, age),
		foldPersons,
	)
}
